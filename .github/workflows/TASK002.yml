name: TASK002 - Layout + Storage uploads for recipe images

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  task002:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Apply changes
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p layouts
          mkdir -p composables

          # =========================
          # 1) layouts/default.vue
          # =========================
          cat > layouts/default.vue <<'EOF'
          <template>
            <div class="min-h-screen bg-white text-gray-900">
              <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-gray-100">
                <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
                  <!-- Left: logo -->
                  <NuxtLink to="/" class="flex items-center gap-2 shrink-0">
                    <div class="w-9 h-9 rounded-2xl bg-gray-900 text-white flex items-center justify-center text-sm font-semibold">
                      R
                    </div>
                    <div class="hidden sm:block font-semibold">
                      –†–µ—Ü–µ–ø—Ç–∏
                    </div>
                  </NuxtLink>

                  <!-- Center: search -->
                  <div class="flex-1 flex justify-center">
                    <form class="w-full max-w-xl" @submit.prevent="onSearch">
                      <div class="relative">
                        <input
                          v-model="q"
                          type="text"
                          class="w-full border border-gray-300 rounded-full pl-4 pr-12 py-2 text-sm
                                 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                          placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é –∞–±–æ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞–º–∏‚Ä¶"
                        />
                        <button
                          type="submit"
                          class="absolute right-1 top-1/2 -translate-y-1/2 px-3 py-1.5 rounded-full text-sm
                                 border border-gray-300 hover:bg-gray-50"
                          aria-label="Search"
                        >
                          üîé
                        </button>
                      </div>
                    </form>
                  </div>

                  <!-- Right: auth / actions -->
                  <div class="flex items-center gap-2 shrink-0">
                    <NuxtLink
                      v-if="user"
                      to="/recipes/create"
                      class="hidden sm:inline-flex rounded-full bg-primary text-white text-sm px-4 py-2 hover:bg-orange-500 transition"
                    >
                      –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–µ—Ü–µ–ø—Ç
                    </NuxtLink>

                    <NuxtLink
                      v-if="!user"
                      to="/auth"
                      class="rounded-full border border-gray-300 text-sm px-4 py-2 hover:bg-gray-50"
                    >
                      –í—Ö—ñ–¥
                    </NuxtLink>

                    <NuxtLink
                      v-else
                      to="/profile"
                      class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-semibold text-sm hover:bg-gray-300 transition"
                      aria-label="Profile"
                    >
                      {{ initials }}
                    </NuxtLink>
                  </div>
                </div>
              </header>

              <main class="max-w-6xl mx-auto px-4 py-6">
                <slot />
              </main>
            </div>
          </template>

          <script setup lang="ts">
          const router = useRouter()
          const route = useRoute()
          const user = useSupabaseUser()

          const q = ref<string>((route.query.q as string) || '')

          const initials = computed(() => {
            const email = user.value?.email || ''
            return email ? email.charAt(0).toUpperCase() : 'U'
          })

          const onSearch = async () => {
            const value = q.value.trim()
            if (!value) {
              await router.push('/search')
              return
            }
            await router.push({ path: '/search', query: { q: value } })
          }
          </script>
          EOF

          # ==================================
          # Storage upload composable
          # ==================================
          cat > composables/useStorageUploads.ts <<'EOF'
          // composables/useStorageUploads.ts
          export function useStorageUploads() {
            const client = useSupabaseClient()

            const BUCKET = 'recipe-images'

            const getExt = (file: File) => {
              const name = file.name || ''
              const parts = name.split('.')
              const ext = parts.length > 1 ? parts.pop() : ''
              return (ext || 'jpg').toLowerCase()
            }

            const uploadFile = async (path: string, file: File) => {
              const { error } = await client.storage.from(BUCKET).upload(path, file, {
                upsert: true,
                cacheControl: '3600',
                contentType: file.type || undefined
              })
              if (error) throw error

              const { data } = client.storage.from(BUCKET).getPublicUrl(path)
              return data.publicUrl
            }

            const uploadMainImage = async (recipeId: string, file: File) => {
              const ext = getExt(file)
              const path = `recipes/${recipeId}/main.${ext}`
              return await uploadFile(path, file)
            }

            const uploadStepImage = async (recipeId: string, stepNumber: number, file: File) => {
              const ext = getExt(file)
              const path = `recipes/${recipeId}/steps/${stepNumber}.${ext}`
              return await uploadFile(path, file)
            }

            return { uploadMainImage, uploadStepImage }
          }
          EOF

          # =========================
          # 2) Update create page
          # =========================
          cat > pages/recipes/create.vue <<'EOF'
          <template>
            <div class="max-w-4xl mx-auto space-y-6">
              <h1 class="text-2xl font-semibold">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ—Ü–µ–ø—Ç–∞</h1>

              <form class="space-y-6" @submit.prevent="onSubmit">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div class="space-y-4">
                    <div class="space-y-1">
                      <label class="text-sm font-medium">–ù–∞–∑–≤–∞</label>
                      <input v-model="form.title" type="text"
                        class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ë–æ—Ä—â" />
                      <p v-if="errors.title" class="text-xs text-red-600">{{ errors.title }}</p>
                    </div>

                    <div class="space-y-1">
                      <label class="text-sm font-medium">–û–ø–∏—Å</label>
                      <textarea v-model="form.description" rows="4"
                        class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="–ö–æ—Ä–æ—Ç–∫–∞ —ñ—Å—Ç–æ—Ä—ñ—è –∞–±–æ –æ–ø–∏—Å —Ä–µ—Ü–µ–ø—Ç–∞" />
                    </div>

                    <!-- Main image upload -->
                    <div class="space-y-2">
                      <div class="flex items-center justify-between">
                        <label class="text-sm font-medium">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç—Ä–∞–≤–∏</label>
                        <button
                          v-if="mainPreviewUrl"
                          type="button"
                          class="text-sm border border-gray-300 rounded-full px-3 py-1.5 hover:bg-gray-50"
                          @click="clearMainImage"
                        >
                          –ü—Ä–∏–±—Ä–∞—Ç–∏
                        </button>
                      </div>

                      <input
                        type="file"
                        accept="image/*"
                        class="block w-full text-sm"
                        @change="onMainImageChange"
                      />
                      <p v-if="errors.mainImage" class="text-xs text-red-600">{{ errors.mainImage }}</p>

                      <div v-if="mainPreviewUrl" class="rounded-2xl overflow-hidden bg-gray-100 aspect-[4/3]">
                        <img :src="mainPreviewUrl" alt="" class="w-full h-full object-cover" />
                      </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div class="space-y-1">
                        <label class="text-sm font-medium">–ß–∞—Å (—Ö–≤)</label>
                        <input v-model.number="form.cook_time_minutes" type="number" min="1"
                          class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
                      </div>

                      <div class="space-y-1">
                        <label class="text-sm font-medium">–ü–æ—Ä—Ü—ñ—ó (–±–∞–∑–æ–≤—ñ)</label>
                        <input v-model.number="form.servings" type="number" min="1" max="50"
                          class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
                        <p v-if="errors.servings" class="text-xs text-red-600">{{ errors.servings }}</p>
                      </div>
                    </div>

                    <div class="space-y-1">
                      <label class="text-sm font-medium">–°–µ–∑–æ–Ω</label>
                      <select v-model="form.season"
                        class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="winter">winter</option>
                        <option value="spring">spring</option>
                        <option value="summer">summer</option>
                        <option value="autumn">autumn</option>
                      </select>
                      <p v-if="errors.season" class="text-xs text-red-600">{{ errors.season }}</p>
                    </div>

                    <div class="flex items-center gap-2">
                      <input id="public" v-model="form.is_public" type="checkbox" class="h-4 w-4" />
                      <label for="public" class="text-sm">–ü—É–±–ª—ñ—á–Ω–∏–π —Ä–µ—Ü–µ–ø—Ç</label>
                    </div>
                  </div>

                  <div class="space-y-6">
                    <div class="border rounded-2xl p-4 space-y-3">
                      <div class="flex items-center justify-between">
                        <h2 class="font-semibold">–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏</h2>
                        <button type="button"
                          class="text-sm border border-gray-300 rounded-full px-3 py-1.5 hover:bg-gray-50"
                          @click="addIngredient">
                          –î–æ–¥–∞—Ç–∏
                        </button>
                      </div>

                      <p v-if="errors.ingredients" class="text-xs text-red-600">{{ errors.ingredients }}</p>

                      <div v-for="(ing, idx) in form.ingredients" :key="ing._key" class="grid grid-cols-12 gap-2 items-start">
                        <div class="col-span-12 sm:col-span-6">
                          <input v-model="ing.name" type="text"
                            class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm"
                            placeholder="–ù–∞–∑–≤–∞" />
                        </div>

                        <div class="col-span-6 sm:col-span-3">
                          <input v-model.number="ing.quantity" type="number" min="0" step="0.01"
                            class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm"
                            placeholder="–ö-—Å—Ç—å" />
                        </div>

                        <div class="col-span-5 sm:col-span-2">
                          <input v-model="ing.unit" type="text"
                            class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm"
                            placeholder="–û–¥–∏–Ω–∏—Ü—è" />
                        </div>

                        <div class="col-span-1 flex justify-end">
                          <button type="button" class="text-gray-500 hover:text-gray-900" @click="removeIngredient(idx)">‚úï</button>
                        </div>

                        <div class="col-span-12">
                          <p v-if="ingredientErrors[idx]" class="text-xs text-red-600">{{ ingredientErrors[idx] }}</p>
                        </div>
                      </div>
                    </div>

                    <div class="border rounded-2xl p-4 space-y-3">
                      <div class="flex items-center justify-between">
                        <h2 class="font-semibold">–ö—Ä–æ–∫–∏</h2>
                        <button type="button"
                          class="text-sm border border-gray-300 rounded-full px-3 py-1.5 hover:bg-gray-50"
                          @click="addStep">
                          –î–æ–¥–∞—Ç–∏
                        </button>
                      </div>

                      <p v-if="errors.steps" class="text-xs text-red-600">{{ errors.steps }}</p>

                      <div v-for="(st, idx) in form.steps" :key="st._key" class="space-y-3 border-t pt-3">
                        <div class="flex items-center justify-between">
                          <div class="text-sm font-medium text-gray-700">–ö—Ä–æ–∫ {{ idx + 1 }}</div>
                          <button type="button" class="text-gray-500 hover:text-gray-900 text-sm" @click="removeStep(idx)">‚úï</button>
                        </div>

                        <textarea v-model="st.text" rows="3" class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm" placeholder="–û–ø–∏—Å –∫—Ä–æ–∫—É" />
                        <p v-if="stepErrors[idx]" class="text-xs text-red-600">{{ stepErrors[idx] }}</p>

                        <!-- Step image upload -->
                        <div class="space-y-2">
                          <div class="flex items-center justify-between">
                            <label class="text-sm font-medium">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫—Ä–æ–∫—É (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                            <button
                              v-if="st.previewUrl"
                              type="button"
                              class="text-sm border border-gray-300 rounded-full px-3 py-1.5 hover:bg-gray-50"
                              @click="clearStepImage(idx)"
                            >
                              –ü—Ä–∏–±—Ä–∞—Ç–∏
                            </button>
                          </div>

                          <input
                            type="file"
                            accept="image/*"
                            class="block w-full text-sm"
                            @change="(e) => onStepImageChange(idx, e)"
                          />

                          <div v-if="st.previewUrl" class="rounded-2xl overflow-hidden bg-gray-100 aspect-[4/3]">
                            <img :src="st.previewUrl" alt="" class="w-full h-full object-cover" />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div v-if="formError" class="border rounded-xl px-4 py-3 text-sm bg-gray-50 text-gray-800">
                  {{ formError }}
                </div>

                <div class="flex justify-end">
                  <button type="submit"
                    class="rounded-full bg-primary text-white px-6 py-2 text-sm hover:bg-orange-500 transition"
                    :disabled="loading">
                    {{ loading ? '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶' : '–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏' }}
                  </button>
                </div>
              </form>
            </div>
          </template>

          <script setup lang="ts">
          definePageMeta({ middleware: 'auth' })

          const router = useRouter()
          const client = useSupabaseClient()
          const user = useSupabaseUser()
          const { addToast } = useToasts()
          const { uploadMainImage, uploadStepImage } = useStorageUploads()

          const loading = ref(false)
          const formError = ref('')

          const mainImageFile = ref<File | null>(null)
          const mainPreviewUrl = ref<string>('')

          const form = reactive({
            title: '',
            description: '',
            cook_time_minutes: null as number | null,
            servings: 2,
            season: 'winter',
            is_public: true,
            ingredients: [] as any[],
            steps: [] as any[]
          })

          const errors = reactive<{ [k: string]: string | undefined }>({})
          const ingredientErrors = ref<string[]>([])
          const stepErrors = ref<string[]>([])

          const makeKey = () => `${Date.now()}-${Math.random()}`

          const addIngredient = () => form.ingredients.push({ _key: makeKey(), name: '', quantity: 0, unit: '' })
          const removeIngredient = (idx: number) => form.ingredients.splice(idx, 1)

          const addStep = () => form.steps.push({ _key: makeKey(), text: '', file: null as File | null, previewUrl: '' as string })
          const removeStep = (idx: number) => form.steps.splice(idx, 1)

          onMounted(() => {
            addIngredient()
            addStep()
          })

          const onMainImageChange = (e: Event) => {
            const input = e.target as HTMLInputElement
            const file = input.files?.[0] || null
            mainImageFile.value = file
            if (mainPreviewUrl.value) URL.revokeObjectURL(mainPreviewUrl.value)
            mainPreviewUrl.value = file ? URL.createObjectURL(file) : ''
          }

          const clearMainImage = () => {
            mainImageFile.value = null
            if (mainPreviewUrl.value) URL.revokeObjectURL(mainPreviewUrl.value)
            mainPreviewUrl.value = ''
          }

          const onStepImageChange = (idx: number, e: Event) => {
            const input = e.target as HTMLInputElement
            const file = input.files?.[0] || null
            const st = form.steps[idx]
            st.file = file
            if (st.previewUrl) URL.revokeObjectURL(st.previewUrl)
            st.previewUrl = file ? URL.createObjectURL(file) : ''
          }

          const clearStepImage = (idx: number) => {
            const st = form.steps[idx]
            st.file = null
            if (st.previewUrl) URL.revokeObjectURL(st.previewUrl)
            st.previewUrl = ''
          }

          const validate = () => {
            for (const k of Object.keys(errors)) errors[k] = undefined
            ingredientErrors.value = []
            stepErrors.value = []
            formError.value = ''

            const t = form.title.trim()
            if (!t) errors.title = '–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É —Ä–µ—Ü–µ–ø—Ç–∞'
            else if (t.length < 3) errors.title = '–ù–∞–∑–≤–∞ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 3 —Å–∏–º–≤–æ–ª–∏'
            else if (t.length > 100) errors.title = '–ù–∞–∑–≤–∞ –º–∞—î –±—É—Ç–∏ –Ω–µ –¥–æ–≤—à–µ 100 —Å–∏–º–≤–æ–ª—ñ–≤'

            if (!form.servings || form.servings < 1 || form.servings > 50) errors.servings = '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ—Ä—Ü—ñ–π –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ–º –≤—ñ–¥ 1 –¥–æ 50'
            if (!form.season) errors.season = '–û–±–µ—Ä—ñ—Ç—å —Å–µ–∑–æ–Ω'

            if (!form.ingredients.length) {
              errors.ingredients = '–î–æ–¥–∞–π—Ç–µ —â–æ–Ω–∞–π–º–µ–Ω—à–µ –æ–¥–∏–Ω —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç'
            } else {
              form.ingredients.forEach((ing, idx) => {
                const nameOk = (ing.name || '').trim().length >= 2
                const qtyOk = typeof ing.quantity === 'number' && ing.quantity > 0
                const unitOk = (ing.unit || '').trim().length >= 1
                let msg = ''
                if (!nameOk) msg = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞'
                else if (!qtyOk) msg = '–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞ –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–æ—é –∑–∞ 0'
                else if (!unitOk) msg = '–û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∞'
                ingredientErrors.value[idx] = msg
              })
            }

            if (!form.steps.length) {
              errors.steps = '–î–æ–¥–∞–π—Ç–µ —â–æ–Ω–∞–π–º–µ–Ω—à–µ –æ–¥–∏–Ω –∫—Ä–æ–∫ –ø—Ä–∏–≥–æ—Ç—É–≤–∞–Ω–Ω—è'
            } else {
              form.steps.forEach((st, idx) => {
                const ok = (st.text || '').trim().length >= 5
                stepErrors.value[idx] = ok ? '' : '–û–ø–∏—Å –∫—Ä–æ–∫—É –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 5 —Å–∏–º–≤–æ–ª—ñ–≤'
              })
            }

            return !Object.values(errors).some(Boolean) && ingredientErrors.value.every(x => !x) && stepErrors.value.every(x => !x)
          }

          const onSubmit = async () => {
            if (!user.value) return
            if (!validate()) return

            loading.value = true
            try {
              // 1) Create recipe row first
              const { data: recipe, error: recipeErr } = await client
                .from('recipes')
                .insert({
                  author_id: user.value.id,
                  title: form.title.trim(),
                  description: form.description.trim(),
                  main_image_url: null,
                  cook_time_minutes: form.cook_time_minutes,
                  servings: form.servings,
                  season: form.season,
                  is_public: form.is_public
                })
                .select('id')
                .single()

              if (recipeErr) throw recipeErr

              // 2) Upload main image (optional) and update recipe
              let mainUrl: string | null = null
              if (mainImageFile.value) {
                mainUrl = await uploadMainImage(recipe.id, mainImageFile.value)
                const { error: upErr } = await client.from('recipes').update({ main_image_url: mainUrl }).eq('id', recipe.id)
                if (upErr) throw upErr
              }

              // 3) Insert ingredients
              const ingredientsPayload = form.ingredients.map((ing, idx) => ({
                recipe_id: recipe.id,
                name: (ing.name || '').trim(),
                quantity: ing.quantity,
                unit: (ing.unit || '').trim(),
                order_index: idx + 1
              }))
              const { error: ingErr } = await client.from('recipe_ingredients').insert(ingredientsPayload)
              if (ingErr) throw ingErr

              // 4) Upload step images (optional) and insert steps
              const stepsPayload = []
              for (let i = 0; i < form.steps.length; i++) {
                const st = form.steps[i]
                const stepNumber = i + 1
                let imageUrl: string | null = null
                if (st.file) {
                  imageUrl = await uploadStepImage(recipe.id, stepNumber, st.file)
                }
                stepsPayload.push({
                  recipe_id: recipe.id,
                  step_number: stepNumber,
                  text: (st.text || '').trim(),
                  image_url: imageUrl
                })
              }

              const { error: stErr } = await client.from('recipe_steps').insert(stepsPayload)
              if (stErr) throw stErr

              addToast('–†–µ—Ü–µ–ø—Ç —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ')
              router.push(`/recipes/${recipe.id}`)
            } catch {
              formError.value = '–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑'
            } finally {
              loading.value = false
            }
          }
          </script>
          EOF

          # =========================
          # 3) Update edit page
          # =========================
          cat > pages/recipes/[id]/edit.vue <<'EOF'
          <template>
            <div v-if="loading" class="text-sm text-gray-600">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>

            <div v-else-if="!recipe" class="text-sm text-gray-600">
              –†–µ—Ü–µ–ø—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.
            </div>

            <div v-else class="max-w-4xl mx-auto space-y-6">
              <h1 class="text-2xl font-semibold">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ä–µ—Ü–µ–ø—Ç–∞</h1>

              <form class="space-y-6" @submit.prevent="onSubmit">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div class="space-y-4">
                    <div class="space-y-1">
                      <label class="text-sm font-medium">–ù–∞–∑–≤–∞</label>
                      <input v-model="form.title" type="text"
                        class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
                      <p v-if="errors.title" class="text-xs text-red-600">{{ errors.title }}</p>
                    </div>

                    <div class="space-y-1">
                      <label class="text-sm font-medium">–û–ø–∏—Å</label>
                      <textarea v-model="form.description" rows="4"
                        class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
                    </div>

                    <!-- Main image replace -->
                    <div class="space-y-2">
                      <div class="flex items-center justify-between">
                        <label class="text-sm font-medium">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç—Ä–∞–≤–∏</label>
                        <button
                          v-if="mainPreviewUrl || form.main_image_url"
                          type="button"
                          class="text-sm border border-gray-300 rounded-full px-3 py-1.5 hover:bg-gray-50"
                          @click="clearMainImage"
                        >
                          –ü—Ä–∏–±—Ä–∞—Ç–∏
                        </button>
                      </div>

                      <input
                        type="file"
                        accept="image/*"
                        class="block w-full text-sm"
                        @change="onMainImageChange"
                      />

                      <div v-if="mainPreviewUrl || form.main_image_url" class="rounded-2xl overflow-hidden bg-gray-100 aspect-[4/3]">
                        <img :src="mainPreviewUrl || form.main_image_url" alt="" class="w-full h-full object-cover" />
                      </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div class="space-y-1">
                        <label class="text-sm font-medium">–ß–∞—Å (—Ö–≤)</label>
                        <input v-model.number="form.cook_time_minutes" type="number" min="1"
                          class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
                      </div>

                      <div class="space-y-1">
                        <label class="text-sm font-medium">–ü–æ—Ä—Ü—ñ—ó (–±–∞–∑–æ–≤—ñ)</label>
                        <input v-model.number="form.servings" type="number" min="1" max="50"
                          class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
                        <p v-if="errors.servings" class="text-xs text-red-600">{{ errors.servings }}</p>
                      </div>
                    </div>

                    <div class="space-y-1">
                      <label class="text-sm font-medium">–°–µ–∑–æ–Ω</label>
                      <select v-model="form.season"
                        class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="winter">winter</option>
                        <option value="spring">spring</option>
                        <option value="summer">summer</option>
                        <option value="autumn">autumn</option>
                      </select>
                      <p v-if="errors.season" class="text-xs text-red-600">{{ errors.season }}</p>
                    </div>

                    <div class="flex items-center gap-2">
                      <input id="public" v-model="form.is_public" type="checkbox" class="h-4 w-4" />
                      <label for="public" class="text-sm">–ü—É–±–ª—ñ—á–Ω–∏–π —Ä–µ—Ü–µ–ø—Ç</label>
                    </div>
                  </div>

                  <div class="space-y-6">
                    <div class="border rounded-2xl p-4 space-y-3">
                      <div class="flex items-center justify-between">
                        <h2 class="font-semibold">–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏</h2>
                        <button type="button" class="text-sm border border-gray-300 rounded-full px-3 py-1.5 hover:bg-gray-50" @click="addIngredient">–î–æ–¥–∞—Ç–∏</button>
                      </div>

                      <p v-if="errors.ingredients" class="text-xs text-red-600">{{ errors.ingredients }}</p>

                      <div v-for="(ing, idx) in form.ingredients" :key="ing._key" class="grid grid-cols-12 gap-2 items-start">
                        <div class="col-span-12 sm:col-span-6">
                          <input v-model="ing.name" type="text" class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm" placeholder="–ù–∞–∑–≤–∞" />
                        </div>
                        <div class="col-span-6 sm:col-span-3">
                          <input v-model.number="ing.quantity" type="number" min="0" step="0.01" class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm" placeholder="–ö-—Å—Ç—å" />
                        </div>
                        <div class="col-span-5 sm:col-span-2">
                          <input v-model="ing.unit" type="text" class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm" placeholder="–û–¥–∏–Ω–∏—Ü—è" />
                        </div>
                        <div class="col-span-1 flex justify-end">
                          <button type="button" class="text-gray-500 hover:text-gray-900" @click="removeIngredient(idx)">‚úï</button>
                        </div>
                        <div class="col-span-12">
                          <p v-if="ingredientErrors[idx]" class="text-xs text-red-600">{{ ingredientErrors[idx] }}</p>
                        </div>
                      </div>
                    </div>

                    <div class="border rounded-2xl p-4 space-y-3">
                      <div class="flex items-center justify-between">
                        <h2 class="font-semibold">–ö—Ä–æ–∫–∏</h2>
                        <button type="button" class="text-sm border border-gray-300 rounded-full px-3 py-1.5 hover:bg-gray-50" @click="addStep">–î–æ–¥–∞—Ç–∏</button>
                      </div>

                      <p v-if="errors.steps" class="text-xs text-red-600">{{ errors.steps }}</p>

                      <div v-for="(st, idx) in form.steps" :key="st._key" class="space-y-3 border-t pt-3">
                        <div class="flex items-center justify-between">
                          <div class="text-sm font-medium text-gray-700">–ö—Ä–æ–∫ {{ idx + 1 }}</div>
                          <button type="button" class="text-gray-500 hover:text-gray-900 text-sm" @click="removeStep(idx)">‚úï</button>
                        </div>

                        <textarea v-model="st.text" rows="3" class="w-full border border-gray-300 rounded-xl px-3 py-2 text-sm" placeholder="–û–ø–∏—Å –∫—Ä–æ–∫—É" />
                        <p v-if="stepErrors[idx]" class="text-xs text-red-600">{{ stepErrors[idx] }}</p>

                        <div class="space-y-2">
                          <div class="flex items-center justify-between">
                            <label class="text-sm font-medium">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫—Ä–æ–∫—É (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                            <button
                              v-if="st.previewUrl || st.image_url"
                              type="button"
                              class="text-sm border border-gray-300 rounded-full px-3 py-1.5 hover:bg-gray-50"
                              @click="clearStepImage(idx)"
                            >
                              –ü—Ä–∏–±—Ä–∞—Ç–∏
                            </button>
                          </div>

                          <input type="file" accept="image/*" class="block w-full text-sm" @change="(e) => onStepImageChange(idx, e)" />

                          <div v-if="st.previewUrl || st.image_url" class="rounded-2xl overflow-hidden bg-gray-100 aspect-[4/3]">
                            <img :src="st.previewUrl || st.image_url" alt="" class="w-full h-full object-cover" />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div v-if="formError" class="border rounded-xl px-4 py-3 text-sm bg-gray-50 text-gray-800">
                  {{ formError }}
                </div>

                <div class="flex justify-end gap-2">
                  <button type="button" class="rounded-full border border-gray-300 px-6 py-2 text-sm hover:bg-gray-50" @click="router.push(`/recipes/${id}`)">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                  </button>
                  <button type="submit" class="rounded-full bg-primary text-white px-6 py-2 text-sm hover:bg-orange-500 transition" :disabled="saving">
                    {{ saving ? '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶' : '–ó–±–µ—Ä–µ–≥—Ç–∏' }}
                  </button>
                </div>
              </form>
            </div>
          </template>

          <script setup lang="ts">
          definePageMeta({ middleware: 'auth' })

          const route = useRoute()
          const router = useRouter()
          const client = useSupabaseClient()
          const user = useSupabaseUser()
          const { addToast } = useToasts()
          const { uploadMainImage, uploadStepImage } = useStorageUploads()

          const id = route.params.id as string

          const loading = ref(true)
          const saving = ref(false)
          const recipe = ref<any | null>(null)

          const formError = ref('')

          const mainImageFile = ref<File | null>(null)
          const mainPreviewUrl = ref<string>('')

          const form = reactive({
            title: '',
            description: '',
            cook_time_minutes: null as number | null,
            servings: 2,
            season: 'winter',
            is_public: true,
            main_image_url: '' as string,
            ingredients: [] as any[],
            steps: [] as any[]
          })

          const errors = reactive<{ [k: string]: string | undefined }>({})
          const ingredientErrors = ref<string[]>([])
          const stepErrors = ref<string[]>([])

          const makeKey = () => `${Date.now()}-${Math.random()}`

          const addIngredient = () => form.ingredients.push({ _key: makeKey(), name: '', quantity: 0, unit: '' })
          const removeIngredient = (idx: number) => form.ingredients.splice(idx, 1)

          const addStep = () => form.steps.push({ _key: makeKey(), text: '', image_url: '' as string, file: null as File | null, previewUrl: '' as string })
          const removeStep = (idx: number) => form.steps.splice(idx, 1)

          const onMainImageChange = (e: Event) => {
            const input = e.target as HTMLInputElement
            const file = input.files?.[0] || null
            mainImageFile.value = file
            if (mainPreviewUrl.value) URL.revokeObjectURL(mainPreviewUrl.value)
            mainPreviewUrl.value = file ? URL.createObjectURL(file) : ''
          }

          const clearMainImage = async () => {
            mainImageFile.value = null
            if (mainPreviewUrl.value) URL.revokeObjectURL(mainPreviewUrl.value)
            mainPreviewUrl.value = ''
            form.main_image_url = ''
          }

          const onStepImageChange = (idx: number, e: Event) => {
            const input = e.target as HTMLInputElement
            const file = input.files?.[0] || null
            const st = form.steps[idx]
            st.file = file
            if (st.previewUrl) URL.revokeObjectURL(st.previewUrl)
            st.previewUrl = file ? URL.createObjectURL(file) : ''
          }

          const clearStepImage = (idx: number) => {
            const st = form.steps[idx]
            st.file = null
            if (st.previewUrl) URL.revokeObjectURL(st.previewUrl)
            st.previewUrl = ''
            st.image_url = ''
          }

          const validate = () => {
            for (const k of Object.keys(errors)) errors[k] = undefined
            ingredientErrors.value = []
            stepErrors.value = []
            formError.value = ''

            const t = form.title.trim()
            if (!t) errors.title = '–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É —Ä–µ—Ü–µ–ø—Ç–∞'
            else if (t.length < 3) errors.title = '–ù–∞–∑–≤–∞ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 3 —Å–∏–º–≤–æ–ª–∏'
            else if (t.length > 100) errors.title = '–ù–∞–∑–≤–∞ –º–∞—î –±—É—Ç–∏ –Ω–µ –¥–æ–≤—à–µ 100 —Å–∏–º–≤–æ–ª—ñ–≤'

            if (!form.servings || form.servings < 1 || form.servings > 50) errors.servings = '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ—Ä—Ü—ñ–π –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ–º –≤—ñ–¥ 1 –¥–æ 50'
            if (!form.season) errors.season = '–û–±–µ—Ä—ñ—Ç—å —Å–µ–∑–æ–Ω'

            if (!form.ingredients.length) {
              errors.ingredients = '–î–æ–¥–∞–π—Ç–µ —â–æ–Ω–∞–π–º–µ–Ω—à–µ –æ–¥–∏–Ω —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç'
            } else {
              form.ingredients.forEach((ing, idx) => {
                const nameOk = (ing.name || '').trim().length >= 2
                const qtyOk = typeof ing.quantity === 'number' && ing.quantity > 0
                const unitOk = (ing.unit || '').trim().length >= 1
                let msg = ''
                if (!nameOk) msg = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞'
                else if (!qtyOk) msg = '–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞ –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–æ—é –∑–∞ 0'
                else if (!unitOk) msg = '–û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∞'
                ingredientErrors.value[idx] = msg
              })
            }

            if (!form.steps.length) {
              errors.steps = '–î–æ–¥–∞–π—Ç–µ —â–æ–Ω–∞–π–º–µ–Ω—à–µ –æ–¥–∏–Ω –∫—Ä–æ–∫ –ø—Ä–∏–≥–æ—Ç—É–≤–∞–Ω–Ω—è'
            } else {
              form.steps.forEach((st, idx) => {
                const ok = (st.text || '').trim().length >= 5
                stepErrors.value[idx] = ok ? '' : '–û–ø–∏—Å –∫—Ä–æ–∫—É –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —â–æ–Ω–∞–π–º–µ–Ω—à–µ 5 —Å–∏–º–≤–æ–ª—ñ–≤'
              })
            }

            return !Object.values(errors).some(Boolean) && ingredientErrors.value.every(x => !x) && stepErrors.value.every(x => !x)
          }

          const load = async () => {
            loading.value = true
            try {
              const { data, error } = await client
                .from('recipes')
                .select('*, recipe_ingredients(*), recipe_steps(*)')
                .eq('id', id)
                .maybeSingle()

              if (error) throw error
              if (!data) {
                recipe.value = null
                return
              }

              if (!user.value || data.author_id !== user.value.id) {
                addToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥—ñ—ó')
                router.push(`/recipes/${id}`)
                return
              }

              recipe.value = data
              form.title = data.title || ''
              form.description = data.description || ''
              form.cook_time_minutes = data.cook_time_minutes ?? null
              form.servings = data.servings || 1
              form.season = data.season || 'winter'
              form.is_public = !!data.is_public
              form.main_image_url = data.main_image_url || ''

              const ings = (data.recipe_ingredients || []).sort((a: any, b: any) => (a.order_index ?? 0) - (b.order_index ?? 0))
              const sts = (data.recipe_steps || []).sort((a: any, b: any) => (a.step_number ?? 0) - (b.step_number ?? 0))

              form.ingredients = ings.map((x: any) => ({ _key: makeKey(), name: x.name, quantity: Number(x.quantity), unit: x.unit || '' }))

              form.steps = sts.map((x: any) => ({
                _key: makeKey(),
                text: x.text,
                image_url: x.image_url || '',
                file: null,
                previewUrl: ''
              }))

              if (!form.ingredients.length) addIngredient()
              if (!form.steps.length) addStep()
            } catch {
              recipe.value = null
            } finally {
              loading.value = false
            }
          }

          onMounted(load)

          const onSubmit = async () => {
            if (!user.value) return
            if (!validate()) return

            saving.value = true
            try {
              // 1) Upload new main image (optional) and set url for update
              let nextMainUrl: string | null = form.main_image_url || null
              if (mainImageFile.value) {
                nextMainUrl = await uploadMainImage(id, mainImageFile.value)
              }

              // 2) Update recipe main fields
              const { error: upErr } = await client
                .from('recipes')
                .update({
                  title: form.title.trim(),
                  description: form.description.trim(),
                  cook_time_minutes: form.cook_time_minutes,
                  servings: form.servings,
                  season: form.season,
                  is_public: form.is_public,
                  main_image_url: nextMainUrl
                })
                .eq('id', id)
              if (upErr) throw upErr

              // 3) Replace ingredients and steps (simple + reliable)
              const { error: delIng } = await client.from('recipe_ingredients').delete().eq('recipe_id', id)
              if (delIng) throw delIng
              const { error: delSteps } = await client.from('recipe_steps').delete().eq('recipe_id', id)
              if (delSteps) throw delSteps

              const ingredientsPayload = form.ingredients.map((ing, idx) => ({
                recipe_id: id,
                name: (ing.name || '').trim(),
                quantity: ing.quantity,
                unit: (ing.unit || '').trim(),
                order_index: idx + 1
              }))
              const { error: ingErr } = await client.from('recipe_ingredients').insert(ingredientsPayload)
              if (ingErr) throw ingErr

              const stepsPayload = []
              for (let i = 0; i < form.steps.length; i++) {
                const st = form.steps[i]
                const stepNumber = i + 1
                let imageUrl: string | null = st.image_url || null
                if (st.file) {
                  imageUrl = await uploadStepImage(id, stepNumber, st.file)
                }
                stepsPayload.push({
                  recipe_id: id,
                  step_number: stepNumber,
                  text: (st.text || '').trim(),
                  image_url: imageUrl
                })
              }
              const { error: stErr } = await client.from('recipe_steps').insert(stepsPayload)
              if (stErr) throw stErr

              addToast('–†–µ—Ü–µ–ø—Ç —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ')
              router.push(`/recipes/${id}`)
            } catch {
              formError.value = '–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑'
            } finally {
              saving.value = false
            }
          }
          </script>
          EOF

          echo "TASK002 applied."

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi
          git add -A
          git commit -m "TASK002: add default layout + upload recipe images to Supabase Storage"

      - name: Push
        shell: bash
        run: |
          git push origin "HEAD:${GITHUB_REF_NAME}"
